<!DOCTYPE html>
<html>
<head>
    <title>Mapa con Leaflet-Geoman</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>

    <div>
        <h3>Geojson:</h3>
        <div id="geojsondiv"></div>
        <button id="cargardb">Cargar DB</button>
        <button id="guardardb">Guardar DB</button>
        <div id="geojsondivres"></div>
    </div>    
    
    <hr>

    <div id="map"></div>

    <!-- jquery: https://github.com/jquery/jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <!-- leaflet: https://github.com/Leaflet/Leaflet -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- geoman: https://github.com/geoman-io/leaflet-geoman -->
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>

    <!-- geocoder: https://github.com/perliedman/leaflet-control-geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <!-- basemap: https://github.com/clavijojuan/L.switchBasemap -->
    <link rel="stylesheet" href="../static/css/L.switchBasemap.css" />
    <script src="../static/js/L.switchBasemap.js"></script>


    
    <script>

        // vars 
        var centro = [-34.61, -58.38];
        var zoom = 13;

        // mapa
        var map = L.map('map').setView(centro, zoom);

        // español
        map.pm.setLang('es'); 
    
        /* old basemap

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        */

        // new basemap argenmap:
        // https://jsbin.com/gaxiwir/edit?html,output
        /*
        L.tileLayer('https://wms.ign.gob.ar/geoserver/gwc/service/tms/1.0.0/capabaseargenmap@EPSG%3A3857@png/{z}/{x}/{-y}.png', {
            attribution: '<a href="https://www.ign.gob.ar/AreaServicios/Argenmap/Introduccion" target="_blank">Instituto Geográfico Nacional</a> + <a href="https://www.osm.org/copyright" target="_blank">OpenStreetMap</a>',
            minZoom: 1, 
            maxZoom: 20
        }).addTo(map);
        */

        // new basemap switch:
        new L.basemapsSwitcher([
        {
            layer: L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map), //DEFAULT MAP
            icon: '../static/img/osm_logo.png',
            name: 'OSM'
        },
        {
            layer: L.tileLayer('https://wms.ign.gob.ar/geoserver/gwc/service/tms/1.0.0/capabaseargenmap@EPSG%3A3857@png/{z}/{x}/{-y}.png', {
            attribution: '<a href="https://www.ign.gob.ar/AreaServicios/Argenmap/Introduccion" target="_blank">Instituto Geográfico Nacional</a> + <a href="https://www.osm.org/copyright" target="_blank">OpenStreetMap</a>',
            minZoom: 1, 
            maxZoom: 20
        }),
            icon: '../static/img/argenmap_logo.jpg',
            name: 'Argenmap'
        }
        ], { position: 'topright' }).addTo(map);        

        // geocoder:
        var geocoder = L.Control.geocoder({
            defaultMarkGeocode: false,
            collapsed: false
        })
        .on('markgeocode', (e) => {
            var bbox = e.geocode.bbox;
            var poly = L.polygon([
            bbox.getSouthEast(),
            bbox.getNorthEast(),
            bbox.getNorthWest(),
            bbox.getSouthWest()
            ]);
            map.fitBounds(poly.getBounds());
        })
        .addTo(map);

        var geometryLayerGroup = L.layerGroup();  // LayerGroup para almacenar las geometrías

        // created geometries (donde iria la geometria del mapa)

        /*
        var initialFeatureCollectionString = '{"type":"FeatureCollection","features":[{"type":"Feature","properties":{},"geometry":{"type":"Point","coordinates":[-58.381691,-34.550478]}},{"type":"Feature","properties":{},"geometry":{"type":"Point","coordinates":[-58.326588,-34.545388]}},{"type":"Feature","properties":{},"geometry":{"type":"Point","coordinates":[-58.328304,-34.567866]}}]}';
        var initialFeatureCollection = JSON.parse(initialFeatureCollectionString);

        // Agregar geometrías iniciales al LayerGroup
        initialFeatureCollection.features.forEach(function(feature) {
            var layer = L.geoJSON(feature).addTo(map);
            geometryLayerGroup.addLayer(layer);
            obtenerFeatureCollection();
        });
        */


        // Agregar el plugin Leaflet-Geoman para edición
        // config geoman
        map.pm.addControls({
            drawText: false,
            drawCircleMarker: false,
            drawCircle: false,
            drawRectangle: false,
            drawPolyline: true,
            drawMarker: true,
            drawPolygon: true,
            editMode: true,
            dragMode: false,
            cutPolygon: false,
            removalMode: true,
            rotateMode: false
        });


        // listen to when a new layer is created
        map.on('pm:create', function(e) {

        console.log('create', e);
        obtenerFeatureCollection();

            // listen to changes on the new layer
            // escucha los cambios al CREAR + EDITAR
            e.layer.on('pm:edit', function(x) {
                console.log('create and edit', x);
                obtenerFeatureCollection();
            });

        });


        // escuchar eventos al eliminar
        map.on('pm:remove', function(event) {
            console.log('remove', event);
            console.log(event.layer);
            obtenerFeatureCollection();
        });


        // Ejemplo de cómo obtener el FeatureCollection al final
        function obtenerFeatureCollection() {

            // <- trae desde getGeomanLayers(), convierte a geojson, stringifea y obtiene las geoms para guardar
            featureCollection = map.pm.getGeomanLayers(true).toGeoJSON();
            var featureCollectionStringify= JSON.stringify(featureCollection);
            console.log('FeatureCollection:', featureCollectionStringify);

            //muestra en el div el resultado

            $('#geojsondiv').text('FeatureCollection: '+featureCollectionStringify);
            
        }



        // modificar en caso de ser necesario, toma el dato del featureCollectionStringify y lo envia como post a guardar geojson
        function guardarFeatureCollectionEnBD() {

            // <- trae desde getGeomanLayers(), convierte a geojson, stringifea y obtiene las geoms para guardar
            featureCollection = map.pm.getGeomanLayers(true).toGeoJSON();
            var featureCollectionStringify= JSON.stringify(featureCollection);

            fetch('/guardar_geojson', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    featureCollection: featureCollectionStringify
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
                $('#geojsondivres').text(data.message);
            })
            .catch(error => {
                console.error('Error al guardar el GeoJSON:', error);
            });
        }

        // guarda al dar click en el boton
        document.getElementById('guardardb').addEventListener('click', function() {
            guardarFeatureCollectionEnBD();
        });



        // modificar en caso de ser necesario, toma el dato del featureCollectionStringify y lo envia como post a guardar geojson
        function cargarFeatureCollectionEnBD() {

        fetch('/cargar_geojson', {
            method: 'POST', //body data
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                idgeom: 2 // <-- variable del id que venga de la basea
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('-------->');
            console.log(data.message);
            console.log(data.geojson);


            // load
            // <-- convertir el geojson desde la base, y desplegarlo en el mapa
            var initialFeatureCollectionString = data.geojson;
            //'{"type":"FeatureCollection","features":[{"type":"Feature","properties":{},"geometry":{"type":"Point","coordinates":[-58.381691,-34.550478]}},{"type":"Feature","properties":{},"geometry":{"type":"Point","coordinates":[-58.326588,-34.545388]}},{"type":"Feature","properties":{},"geometry":{"type":"Point","coordinates":[-58.328304,-34.567866]}}]}';
            var initialFeatureCollection = JSON.parse(initialFeatureCollectionString);

            // Agregar geometrías iniciales al LayerGroup
            initialFeatureCollection.features.forEach(function(feature) {

            /* ejemplo featurecollection beautificado:

            {
            "type": "FeatureCollection",
            "features": [
                {
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                    -58.361263,
                    -34.561929
                    ]
                }
                },
                {
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                    -58.387699,
                    -34.57776
                    ]
                }
                },
                {
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                    -58.328133,
                    -34.576912
                    ]
                }
                }
            ]
            }*/

                // itera por cada feature del feature collection,
                // crea una capa tipo geojson, y la agrega al mapa
                var layer = L.geoJSON(feature).addTo(map);
                geometryLayerGroup.addLayer(layer);

                // fix: 20230815: escuchar eventos al editar la capa sin pm:create
                layer.on('pm:edit', function(event) {
                    console.log('edit', event);
                    console.log(event.layer);
                    obtenerFeatureCollection();
                });
                

                // fly to bounds
                map.flyToBounds(L.geoJson(map.pm.getGeomanLayers(true).toGeoJSON()).getBounds());

                // solo para validar en console.log:
                obtenerFeatureCollection();
            });

        })
        .catch(error => {
            console.error('Error al cargar el GeoJSON:', error);
        });
        }


        // guarda al dar click en el boton
        document.getElementById('cargardb').addEventListener('click', function() {
            cargarFeatureCollectionEnBD();
        });



    
    </script>
    
</body>
</html>
